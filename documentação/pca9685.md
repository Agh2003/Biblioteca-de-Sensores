# PCA9685
Classe para controle do driver PWM **PCA9685** utilizando a Banana Pi M4 Zero, via barramento I2C, com suporte ao multiplexador **TCA9548A**.  
Permite configurar frequência de PWM global, duty cycle individual de cada canal, além de controle direto dos valores ON/OFF.

---

## Requisitos
- [smbus2](https://pypi.org/project/smbus2/) (para comunicação I2C)
- [time](https://docs.python.org/3/library/time.html)

---

## Funcionalidades
- Seleção automática do canal do multiplexador TCA9548A.
- Reset do PCA9685 para estado padrão.
- Configuração de frequência global de PWM.
- Controle de duty cycle individual por canal (0.0 – 1.0).
- Controle direto dos registradores ON/OFF de cada canal.

---

## Constantes
- **`I2C_DEVICE`**: Número do barramento I2C (`/dev/i2c-1`).
- **`TCA9548A_ADDR`**: Endereço I2C do multiplexador TCA9548A (`0x70`).
- **`PCA9685_ADDR`**: Endereço I2C do PCA9685 (`0x40`).
- **`__MODE1`**: Registrador de controle principal do PCA9685.
- **`__PRESCALE`**: Registrador para configuração da frequência PWM.
- **`__LED0_ON_L`**: Endereço base do primeiro registrador do canal 0 (utilizado para calcular os endereços dos outros canais).

---

## Atributos da Classe
- **`bus`**: Instância `smbus2.SMBus` utilizada para comunicação I2C.
- **`address`**: Endereço I2C do PCA9685 (`0x40`).
- **`mux_address`**: Endereço I2C do multiplexador TCA9548A.
- **`mux_channel`**: Canal do multiplexador atualmente ativo.

---

## Métodos da Classe

### `__init__(self, mux_channel=0)`
Construtor da classe. Inicializa o barramento I2C, seleciona o canal no MUX e reseta o PCA9685 para estado padrão.

- **Parâmetros**:
    - `mux_channel` (int): Canal do multiplexador TCA9548A (0–7).

- **Comportamento**:
    - Seleciona o canal do MUX com `select_mux_channel`.
    - Reseta o PCA9685 com `reset`.

---

### `select_mux_channel(self, channel)`
Seleciona o canal ativo do TCA9548A.

- **Parâmetros**:
    - `channel` (int): número do canal (0–7).

- **Exceções**:
    - Lança `ValueError` se o canal estiver fora do intervalo válido.

---

### `reset(self)`
Reseta o PCA9685 para o modo padrão escrevendo `0x00` no registrador MODE1.

---

### `set_pwm_freq(self, freq_hz)`
Configura a frequência de PWM para todos os canais.

- **Parâmetros**:
    - `freq_hz` (float): frequência em Hz (ex.: `50` para servos padrão).

- **Comportamento**:
    - Calcula o valor de prescale usando a fórmula  
      `prescale = round(25MHz / (4096 * freq_hz)) - 1`.
    - Coloca o PCA9685 em modo **sleep** para alterar o prescale.
    - Escreve o novo prescale no registrador `__PRESCALE`.
    - Sai do modo sleep e ativa o auto-incremento para aplicar a nova frequência.

---

### `set_pwm(self, channel, on, off)`
Configura manualmente os valores de início e término do pulso para um canal específico.

- **Parâmetros**:
    - `channel` (int): Canal de 0 a 15.
    - `on` (int): Valor de início do pulso (0–4095).
    - `off` (int): Valor de término do pulso (0–4095).

- **Comportamento**:
    - Calcula os endereços dos registradores correspondentes ao canal.
    - Escreve os quatro bytes necessários: `ON_L`, `ON_H`, `OFF_L`, `OFF_H`.

---

### `set_pwm_duty_cycle(self, channel, duty_cycle)`
Configura o duty cycle de um canal de forma simplificada.

- **Parâmetros**:
    - `channel` (int): Canal de 0 a 15.
    - `duty_cycle` (float): Valor entre 0.0 e 1.0 representando a fração do tempo ativo.

- **Comportamento**:
    - Converte o duty cycle para um valor entre 0 e 4095.
    - Chama `set_pwm(channel, 0, off_value)` para aplicar.

---

## Exemplo

```python
from pca9685 import PCA9685
import time

# Inicializa PCA9685 no canal 0 do MUX
pwm = PCA9685(mux_channel=0)

# Configura frequência para 50 Hz (ideal para controle de servos)
pwm.set_pwm_freq(50)

# Move um servo no canal 0 para diferentes posições
try:
    while True:
        print("Movendo servo para posição mínima")
        pwm.set_pwm_duty_cycle(0, 0.05)  # ~5% duty cycle
        time.sleep(1)

        print("Movendo servo para posição máxima")
        pwm.set_pwm_duty_cycle(0, 0.10)  # ~10% duty cycle
        time.sleep(1)

except KeyboardInterrupt:
    print("\nEncerrando controle do PCA9685")
