# TCS34725
A classe `tcs34725` é responsável por gerenciar a comunicação com o sensor de cor TCS34725 conectado via I2C (com suporte ao multiplexador TCA9548A). Ela fornece inicialização do sensor, leitura dos canais brutos (R, G, B, C), calibração para branco/preto, normalização dos valores para a escala 0–255 e identificação da cor predominante.

---

## Requisitos
- time
- [smbus2](https://pypi.org/project/smbus2/)
- Módulo `configuracao.py` disponível no projeto — provê a classe Configuracao utilizada para salvar/recuperar os valores de calibração (arquivo .pkl).

---

## Funcionalidades
- Inicialização automática do sensor e seleção do canal no multiplexador TCA9548A.
- Leitura dos canais brutos: Red (R), Green (G), Blue (B) e Clear (C).
- Calibração para superfícies branca e preta (salva/recupera valores de calibração).
- Normalização dos valores brutos para a faixa 0–255 usando calibração.
- Identificação simples da cor predominante (Preto, Branco, Vermelho, Verde, Azul, Indefinido).

---

## Constantes
- **`I2C_DEVICE`**: Número do barramento I2C utilizado (ex.: /dev/i2c-1).
- **`TCA9548A_ADDR`**: Endereço I2C do multiplexador TCA9548A (0x70).
- **`TCS34725_ADDR`**: Endereço I2C do sensor TCS34725 (0x29).
- **`COMMAND_BIT`**: Bit de comando (0x80) necessário para acessar os registradores do sensor.

---

## Atributos da Classe
- **`bus`**: Instância SMBus usada para a comunicação I2C.

- **`chave_sensor`**: Chave identificadora (string) usada para diferenciar entradas de calibração no arquivo de configuração (padrão: "sensor_tcs34725").

- **`config`**: Instância de Configuracao("calibracao_tcs34725") usada para persistir calibração.

- **`CHAVE_PRETO`**: Nome da chave de armazenamento para calibração de preto (ex.: "sensor_tcs34725_preto").

- **`CHAVE_BRANCO`**: Nome da chave de armazenamento para calibração de branco (ex.: "sensor_tcs34725_branco").

- **`valores_min`**: Tupla (r,g,b,c) com a calibração de preto carregada do arquivo (ou None).

- **`valores_max`**: Tupla (r,g,b,c) com a calibração de branco carregada do arquivo (ou None).

---

## Métodos da Classe

### `__init__(self, canal_mux, chave_sensor: str = "sensor_tcs34725")`
Construtor da classe. Inicializa a comunicação I2C, seleciona o canal do multiplexador, habilita o sensor e aplica configurações iniciais (tempo de integração e ganho). Cria/abre a instância Configuracao e tenta carregar valores de calibração salvos.

- **Parâmetros**:
    - `canal_mux` (int): Canal do TCA9548A que contém o sensor.
    - `chave_sensor` (str, opcional): Chave para salvar/recuperar calibração.

---

### `close(self)`
Fecha o barramento I2C (self.bus.close()).

---

### `_selecionar_canal_mux(self, canal)`
Método auxiliar. Ativa apenas o canal especificado no multiplexador TCA9548A escrevendo no endereço do MUX: `bus.write_byte(TCA9548A_ADDR, 1 << canal)`.

- **Parâmetros**:
    - `canal` (int): Índice do canal a ser ativado no multiplexador.

---

### `_write8(self, reg, valor)`
Escreve 1 byte (`valor`) no registrador `reg` do sensor (usa `COMMAND_BIT | reg`).

- **Parâmetros**:
    - `reg` (int): Endereço do registrador.
    - `valor` (int): Byte a escrever.

---

### `_read8(self, reg)`
Lê 1 byte do registrador `reg` do sensor e retorna o valor lido.

- **Parâmetros**:
    - `reg` (int): Endereço do registrador.

- **Retorno**:
    - `int` → 1 byte lido.

---

### `_read16(self, reg)`
Lê 2 bytes (word) a partir do registrador `reg` e combina em inteiro de 16 bits (low byte primeiro).

- **Parâmetros**:
    - `reg` (int): Endereço do registrador inicial.

- **Retorno**:
    - `int` → valor de 16 bits (0..65535).

---

### `_habilitar_sensor(self)`
Liga o sensor (Power ON) e habilita a leitura RGBC (escritas em registrador 0x00: `0x01` e `0x03`).

---

### `_tempo_integracao(self, ms)`
Configura o tempo de integração (registrador ATIME). Converte milissegundos para o valor do registrador com a fórmula:

- **Parâmetros**:
    - `ms` (int/float): tempo de integração em milissegundos (ex.: 24).

---

### `_ganho(self, ganho)`
Configura o ganho (registrador CONTROL). Valores suportados: `1x`, `4x`, `16x`, `60x`.

- **Parâmetros**:
    - `ganho` (int): valor do ganho (1, 4, 16, 60). Caso não encontrado, usa `4x` como padrão.

---

### `ler_cores(self)`
Lê os canais brutos RGBC do sensor.

- **Retorno**:
    - `tuple (r, g, b, c)` onde cada elemento é um inteiro lido a partir dos registradores:
        - Clear: registrador 0x14
        - Red: registrador 0x16
        - Green: registrador 0x18
        - Blue: registrador 0x1A

---

### `calibrar(self, amostras)`
Realiza calibração interativa para branco e preto:
- Solicita ao usuário posicionar o sensor sobre uma superfície branca e pressionar ENTER.
- Coleta `amostras` leituras e calcula a média (via `_media`).
- Repete para a superfície preta.
- Persiste `valores_max` (branco) e `valores_min` (preto) com `self.config.insere`.

- **Parâmetros**:
    - `amostras` (int): número de leituras a serem feitas para a média.

- **Observações**:
    - Salva valores em arquivo de calibração controlado por `Configuracao("calibracao_tcs34725")`.

---

###  `_media(self, amostras)`
Média aritmética de `amostras` leituras consecutivas de `ler_cores()`.

- **Parâmetros**:
    - `amostras` (int): número de leituras para computar a média.

- **Retorno**:
    - `tuple` média `(r_avg, g_avg, b_avg, c_avg)` — valores inteiros.

---

### `cores_normalizadas(self)`
Calcula a normalização dos valores brutos (R,G,B,C) para a escala 0–255 usando `valores_min` e `valores_max` (calibração).

- **Retorno**:
    - `tuple (r_n, g_n, b_n, c_n)` com valores inteiros 0..255.

- **Exceções**:
    - Levanta `RuntimeError` se `valores_min` ou `valores_max` forem `None` (ou seja, sensor não calibrado).

---

### `nome_cor(self)`
Determina um nome de cor simples a partir dos valores normalizados:

- **Regras implementadas**:
    - Se `r, g, b` todos < 20 → `"Preto"`.
    - Se `r, g, b` todos > 220 → `"Branco"`.
    - Se `r` maior que `g` e `b` → `"Vermelho"`.
    - Se `g` maior que `r` e `b` → `"Verde"`.
    - Se `b` maior que `r` e `g` → `"Azul"`.
    - Caso contrário → `"Indefinido"`.

- **Retorno**:
    - `str` com o nome da cor.

---

## Exemplo
```python
from tcs34725 import TCS34725
import time

# Inicializa o sensor no canal 1 do multiplexador
sensor = TCS34725(canal_mux=1)

try:
    # Se não houver calibração salva, realiza calibração interativa
    if sensor.valores_min is None or sensor.valores_max is None:
        print("Nenhuma calibração salva. Iniciando calibração...")
        sensor.calibrar(amostras=100)
    else:
        print("Calibração carregada do arquivo.")

    # Loop de leitura
    while True:
        cores = sensor.cores_normalizadas()   # (r,g,b,c) em 0..255
        cor_nome = sensor.nome_cor()
        print(f"Normalizado: {cores} -> {cor_nome}")
        time.sleep(0.5)

except KeyboardInterrupt:
    print("Encerrando...")

finally:
    sensor.close()
